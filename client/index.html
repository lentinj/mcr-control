<html>
<head>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<style>
.osd {
    border: 1px solid black;
    padding: 1rem;
}
.osd > * {
    margin: 0;
    padding: 0;
    height: 1.5rem;
}

.osd > *:first-child {
    text-align: center;
    font-weight: bold;
}

.osd > *.folder {
    color: green;
}
.osd > *.active {
    background: yellow;
}
.osd > *:after {
    position: absolute;
    right: 20;
    content: attr(data-bits);
}

table.dpad {
    text-align: center;
}
table.dpad button {
    width: 4rem;
}

</style>
</head>
<body style="margin: 5px;">

<button data-bind="click: vol_up">Up</button>
<button data-bind="click: vol_dn">Down</button>
<button data-bind="click: mute_toggle">Mute</button>
<span data-bind="text: muted() ? 'MUTE' : volume()"></span>

<select
    style="float: right; margin: 7px 7px 0 0;"
    data-bind="
        options: favourites,
        optionsValue: 'id',
        optionsText: 'text',
        value: selected_favourite,
        "></select>

<p></p>

<ul class="nav nav-tabs" data-bind="foreach: available_inputs">
  <li class="nav-item">
    <a class="nav-link active" href="#" data-toggle="tab" role="tab" data-bind="
        click: function () { $parent.change_input(value); },
        css: { active: $parent.input() === value },
        attr: {
            'aria-controls': value,
            'aria-selected': $parent.input() === value,
            id: value + '-tab' },
        text: text"></a>
  </li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade show" role="tabpanel" aria-labelledby="STANDBY-tab"
      data-bind="css: { show: input() === 'STANDBY', active: input() === 'STANDBY'}">
    zzzz
  </div>

  <div class="tab-pane fade show" role="tabpanel" aria-labelledby="SERVER-tab"
      data-bind="
          css: {
              show: ['SERVER', 'IRADIO', 'BLUETOOTH'].indexOf(input()) > -1,
              active: ['SERVER', 'IRADIO', 'BLUETOOTH'].indexOf(input()) > -1,
          }">
    <div class="osd" data-bind="click: tick, foreach: osd">
        <div data-bind="
            attr: { 'data-bits': bits, 'class': type().join(' ') },
            text: text"></div>
    </div>
  </div>

  <div class="tab-pane fade show" role="tabpanel" aria-labelledby="TUNER-tab"
      data-bind="
          css: {
              show: ['TUNER'].indexOf(input()) > -1,
              active: ['TUNER'].indexOf(input()) > -1,
          }">

    <ul class="nav nav-tabs" data-bind="foreach: available_bands">
      <li class="nav-item">
        <a class="nav-link" href="#" data-toggle="tab" role="tab" data-bind="
            click: function () { $parent.tuner_band_change(value); },
            css: { active: $parent.tuner_band() === value },
            attr: {
                'aria-controls': value,
                'aria-selected': $parent.tuner_band() === value,
                id: value + '-tab' },
            text: text"></a>
      </li>
    </ul>

    <div class="osd" data-bind="click: tick">
      <div><span data-bind="text: tuner_name"></span> (<span data-bind="text: tuner_freq"></span>)</div>
    </div>
  </div>

</div>

<table class="dpad">
  <tr>
    <td></td>
    <td><button data-bind="click: d_pad_press('up')">Up</button></td>
    <td></td>
  </tr><tr>
    <td><button data-bind="click: d_pad_press('left')">Left</button></td>
    <td><button data-bind="click: d_pad_press('enter')">Enter</button></td>
    <td><button data-bind="click: d_pad_press('right')">Right</button></td>
  </tr><tr>
    <td></td>
    <td><button data-bind="click: d_pad_press('down')">Down</button></td>
    <td></td>
  </tr>
</table>

<script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"></script>
<script>
function OsdLine() {
    this.text = ko.observable('');
    this.bits = ko.observable(0);

    this.type = ko.pureComputed(function () {
        rv = [];
        if (this.bits() & 0x1) { rv.push('file'); }
        if (this.bits() & 0x2) { rv.push('folder'); }
        if (this.bits() & 0x8) { rv.push('active'); }
        return rv;
    }, this);

    this.active = ko.pureComputed(function () {
        return (this.bits() & 0x8);
    }, this);
}

function Favourite(initial_id, initial_text) {
    this.id = ko.observable(initial_id);
    this.text = ko.observable(initial_text);
}

function ViewModel() {
    this.power = ko.observable(false);
    this.available_inputs = [
         { value: 'STANDBY', text: 'Standby' },
         { value: 'TUNER', text: 'Tuner' },
         { value: 'SERVER', text: 'DLNA' },
         { value: 'IRADIO', text: 'Internet radio' },
         { value: 'CD', text: 'CD' },
         { value: 'BLUETOOTH', text: 'Bluetooth' },
    ]
    this.input = ko.observable("");
    this.volume = ko.observable(0);
    this.muted = ko.observable(false);
    this.osd = [new OsdLine(), new OsdLine(), new OsdLine(), new OsdLine(), new OsdLine(), new OsdLine(), new OsdLine(), new OsdLine(), new OsdLine()];
    this.favourites = ko.observableArray([new Favourite(0, "Select a favourite...")]);
    this.selected_favourite = ko.observable();
    this.available_bands = [
         { value:'DA', text: 'Digital' },
         { value:'FM', text: 'FM' },
    ];
    this.tuner_band = ko.observable("");
    this.tuner_name = ko.observable("");
    this.tuner_freq = ko.observable(0);

    this.incoming = function (data) {
        var i, m;

        for (i = 0; i < this.incoming_handlers.length; i++) {
            m = data.match(this.incoming_handlers[i][0]);

            if (m) {
                this.incoming_handlers[i][1].call(this, m);
                return;
            }
        }
        console.log("Unhandled: " + data);
    };

    this.incoming_handlers = [
        [/^PW(ON|STANDBY)$/, function (m) {
            this.power(m[1] === 'ON');
            if (m[1] === 'STANDBY') { this.input('STANDBY'); }
        }],
        [/^SI(.*)$/, function (m) {
            if (this.power()) {
                this.input(m[1]);
            } else {
                this.input('STANDBY');
            }
        }],
        [/^MV(?:VOA)?(\d{2})$/, function (m) {
            this.volume(parseInt(m[1], 10));
        }],
        [/^MU(?:VOA)?(ON|OFF)$/, function (m) {
            this.muted(m[1] === 'ON');
        }],
        [/^NS[AE](\d)/, function (m) {
            var line, i = parseInt(m[1], 10),
                line = m.input.substr(4);

            if (i > 0 && i < 8) {
                this.osd[i].bits(line.charCodeAt(0));
                line = line.substr(1);
            } else {
                this.osd[i].bits(0);
            }

            this.osd[i].text(line);
        }],
        [/^FV(\d{2})\s*(.*)$/, function (m) {
            var id = parseInt(m[1], 10);

            if(this.favourites.length < id) {
                // TODO: Something sensible
                this.favourites.push(new Favourite(id, m[2]));
            } else {
                this.favourites()[id] = new Favourite(id, m[2]);
            }
        }],
        [/^TMAN(AM|FM)$/, function (m) {
            this.tuner_band(m[1]);
        }],
        [/^TMDA$/, function (m) {
            this.tuner_band("DA");
        }],
        [/^(TFDANAME|TFANNAME)(.*)/, function (m) {
            this.tuner_name(m[2]);
        }],
        [/^TFAN([0-9]+)/, function (m) {
            this.tuner_freq(parseInt(m[1], 10) / 100);
        }],
        [/^TFDA000$/, function (m) {
            this.tuner_freq("");
        }],
        [/^TFDA(\d\d[A-Z]) ([0-9.]+)/, function (m) {
            this.tuner_freq(m[1] + ' ' + m[2]);
        }],
        [/^TMAN(AUTO|MANUAL)/, function (m) {
            // We don't care if tuner is in manual or auto mode
        }],
    ];

    this.selected_favourite.subscribe(function (new_id) {
        if (new_id === 0) {
            return;
        }

        send_cmd("PWON");

        send_cmd("FV " + (new_id < 10 ? "0" : "") + new_id);
        //window.setTimeout(this.call(this, 0), 1000);
    });

    this.tick = function() {
        switch (this.input()) {
            case 'SERVER':
            case 'IRADIO':
            case 'BLUETOOTH':
                send_cmd("NSE");
                break;
            case 'TUNER':
                send_cmd("TM?");
                break;
        }
    };
    setInterval(this.tick.bind(this), 10000);

    this.power_toggle = function () { send_cmd(this.power() ? "PWSTANDBY" : "PWON"); };
    this.change_input = function (i) {
        if (i === 'STANDBY') {
            send_cmd("PWSTANDBY");
        } else if (!this.power()) {
            send_cmd("PWON");
            window.setTimeout(send_cmd, 300, "SI" + i);
        } else {
            send_cmd("SI" + i);
        }
    };
    this.tuner_band_change = function (b) {
        send_cmd(b === 'DA' ? "TMDA" : ("TMAN" + b));
    }
    this.vol_up = function () { send_cmd("MVUP"); };
    this.vol_dn = function () { send_cmd("MVDOWN"); };
    this.mute_toggle = function () { send_cmd(this.muted() ? "MUOFF" : "MUON"); };
    this.mute_on = function () { send_cmd("MUON"); };
    this.mute_off = function () { send_cmd("MUOFF"); };

    this.d_pad_press = function (direction) {
        switch (this.input()) {
            case 'SERVER':
            case 'IRADIO':
            case 'BLUETOOTH':
                send_cmd( direction === 'up' ? "NS90"
                        : direction === 'down' ? "NS91"
                        : direction === 'left' ? "NS92"
                        : direction === 'right' ? "NS93"
                        : direction === 'enter' ? "NS94"
                        : "");
                break;
            case 'TUNER':
                send_cmd( direction === 'up' ? "TFANUP"
                        : direction === 'down' ? "TFANDOWN"
                        : direction === 'left' ? "TFANUP"
                        : direction === 'right' ? "TFANDOWN"
                        : "");
                break;
        }
        window.setTimeout(this.tick.bind(this), 300);
    };
}

const socket = new WebSocket('ws://' + document.location.host + '/');
const vm = new ViewModel();

socket.addEventListener('message', function (event) {
    vm.incoming(event.data);
});

socket.addEventListener('open', function (event) {
    send_cmd("PW?");
    send_cmd("MV?");
    send_cmd("SI?");
    send_cmd("NSE");
    send_cmd("FV ?");
});

function send_cmd(cmd) {
    socket.send(cmd);
}

ko.applyBindings(vm);
</script></body>
</html>
